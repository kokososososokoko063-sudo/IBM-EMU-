<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Super IBM 5150 Plus</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');

        :root {
            --bezel-color: #dcd6c8;
            --screen-black: #050505;
            /* Default Blue Theme */
            --phosphor-main: #55ffff; 
            --phosphor-dim: #00aaaa;
            --phosphor-glow: rgba(85, 255, 255, 0.4);
        }

        /* Themes */
        .theme-green {
            --phosphor-main: #33ff00;
            --phosphor-dim: #1a8000;
            --phosphor-glow: rgba(51, 255, 0, 0.4);
        }
        .theme-amber {
            --phosphor-main: #ffb000;
            --phosphor-dim: #996a00;
            --phosphor-glow: rgba(255, 176, 0, 0.4);
        }
        .theme-white {
            --phosphor-main: #ffffff;
            --phosphor-dim: #888888;
            --phosphor-glow: rgba(255, 255, 255, 0.4);
        }

        * { box-sizing: border-box; }

        body {
            background-color: #080808;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            overflow: hidden;
            font-family: 'VT323', monospace;
            user-select: none;
            -webkit-user-select: none;
        }

        .monitor-casing {
            width: 95vw;
            max-width: 960px;
            aspect-ratio: 4/3;
            background-color: var(--bezel-color);
            border-radius: 20px;
            padding: 30px;
            position: relative;
            box-shadow: 
                inset 0 0 40px rgba(0,0,0,0.3),
                0 0 100px rgba(0,0,0,0.8),
                10px 10px 0px rgba(20,20,20,0.5);
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: transform 0.1s;
        }

        .badge-ibm {
            position: absolute;
            top: 15px;
            left: 30px;
            background: #222;
            color: #ccc;
            padding: 4px 12px;
            font-family: 'Courier New', serif;
            font-weight: bold;
            border-left: 4px solid #aaa;
            box-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            font-size: 16px;
            letter-spacing: 1px;
            z-index: 10;
            text-transform: uppercase;
        }

        .screen-container {
            width: 100%;
            height: 82%;
            background: #000;
            border-radius: 5% / 5%; /* More subtle curve */
            position: relative;
            overflow: hidden;
            box-shadow: inset 0 0 60px rgba(100,100,100,0.1);
            border: 15px solid #1a1a1a;
        }

        /* CRT Display Grid */
        #crt-display {
            width: 100%;
            height: 100%;
            background-color: var(--screen-black);
            color: var(--phosphor-main);
            font-size: 1.4rem; 
            line-height: 1;
            white-space: pre;
            padding: 15px;
            text-shadow: 0 0 2px var(--phosphor-dim), 0 0 5px var(--phosphor-glow);
            font-family: 'VT323', monospace;
            overflow: hidden;
            cursor: default;
            display: grid;
            grid-template-rows: repeat(25, 1fr);
            grid-template-columns: repeat(80, 1fr);
            gap: 0;
            /* Authentic DOS look is LTR even for Arabic text usually */
            direction: ltr; 
        }

        /* Responsive Font Size */
        @media (max-width: 800px) {
            #crt-display { font-size: 1rem; padding: 5px; }
            .monitor-casing { padding: 10px; width: 98vw; aspect-ratio: auto; height: 70vh; }
        }

        .char-cell {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
        
        .char-cell.inverted {
            background-color: var(--phosphor-main);
            color: var(--screen-black);
            text-shadow: none;
        }

        /* Scanlines & Effects */
        .overlay-scanlines {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%);
            background-size: 100% 4px;
            pointer-events: none;
            z-index: 10;
            opacity: 0.7;
        }
        
        .overlay-glow {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: radial-gradient(circle, rgba(255,255,255,0.02) 0%, rgba(0,0,0,0.4) 90%);
            pointer-events: none;
            z-index: 9;
            animation: flicker 0.1s infinite;
        }

        @keyframes flicker { 0% { opacity: 0.97; } 100% { opacity: 1; } }

        /* Controls */
        .controls-panel {
            margin-top: auto;
            width: 100%;
            display: flex;
            justify-content: space-between;
            padding: 0 20px;
            align-items: center;
            height: 60px;
            background: linear-gradient(to bottom, transparent, rgba(0,0,0,0.1));
            border-radius: 0 0 15px 15px;
        }

        .brand-label {
            font-size: 12px;
            color: #666;
            font-weight: bold;
            text-shadow: 0 1px 0 rgba(255,255,255,0.5);
        }

        .power-group {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .big-red-switch {
            width: 50px;
            height: 30px;
            background: #a00;
            border: 3px solid #600;
            cursor: pointer;
            box-shadow: inset 2px 2px 5px rgba(255,255,255,0.2), 2px 2px 2px rgba(0,0,0,0.3);
            position: relative;
            transition: all 0.1s;
        }
        .big-red-switch:active { transform: scale(0.95); background: #800; }
        .big-red-switch::after {
            content: 'I  O';
            color: #fff;
            font-size: 10px;
            position: absolute;
            top: -15px;
            left: 12px;
            font-family: sans-serif;
            color: #444;
        }

        .led-indicator {
            width: 12px; height: 12px;
            background: #311;
            border-radius: 50%;
            border: 1px solid #222;
            transition: 0.3s;
        }
        .led-indicator.on {
            background: #f00;
            box-shadow: 0 0 10px #f33;
        }

        /* Mobile Controls (Hidden on Desktop) */
        .mobile-controls {
            display: none;
            width: 100%;
            max-width: 400px;
            padding: 10px;
            gap: 10px;
        }
        
        @media (hover: none) and (pointer: coarse) {
            .mobile-controls { display: grid; grid-template-columns: 1fr 1fr; }
            .monitor-casing { margin-bottom: 20px; }
            body { height: auto; padding: 20px 0; overflow-y: auto; }
        }

        .d-pad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 5px;
            background: #222;
            padding: 10px;
            border-radius: 10px;
        }
        .action-pad {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5px;
            background: #222;
            padding: 10px;
            border-radius: 10px;
        }

        .mob-btn {
            background: #444;
            color: #fff;
            border: 2px solid #666;
            border-radius: 5px;
            padding: 15px 0;
            font-family: 'VT323';
            font-size: 20px;
            text-align: center;
            user-select: none;
            cursor: pointer;
        }
        .mob-btn:active { background: #666; border-color: #888; }
        .mob-btn.center { grid-column: 2; }

        /* Hidden Input Trap */
        #keyboard-trap { position: absolute; opacity: 0; top: -1000px; }

    </style>
</head>
<body>

    <div class="monitor-casing" id="casing">
        <div class="badge-ibm">IBM Personal Computer</div>
        
        <div class="screen-container" onclick="focusTrap()">
            <div class="overlay-scanlines"></div>
            <div class="overlay-glow"></div>
            <div id="crt-display"></div>
        </div>

        <div class="controls-panel">
            <div class="brand-label">5150 SYSTEM UNIT</div>
            <div class="power-group">
                <div style="font-size: 10px; color: #444; font-family: sans-serif;">POWER</div>
                <div class="led-indicator" id="power-led"></div>
                <div class="big-red-switch" onclick="toggleSystemPower()"></div>
            </div>
        </div>
    </div>

    <!-- Mobile Controls -->
    <div class="mobile-controls">
        <div class="d-pad">
            <div></div>
            <div class="mob-btn" onpointerdown="simulateKey('ArrowUp')">▲</div>
            <div></div>
            <div class="mob-btn" onpointerdown="simulateKey('ArrowLeft')">◄</div>
            <div class="mob-btn" onpointerdown="simulateKey('ArrowDown')">▼</div>
            <div class="mob-btn" onpointerdown="simulateKey('ArrowRight')">►</div>
        </div>
        <div class="action-pad">
            <div class="mob-btn" style="background:#522;" onpointerdown="simulateKey('Escape')">ESC</div>
            <div class="mob-btn" style="background:#252;" onpointerdown="simulateKey('Enter')">ENT</div>
            <div class="mob-btn" onpointerdown="simulateKey('Backspace')">DEL</div>
            <div class="mob-btn" onpointerdown="simulateKey(' ')">SPC</div>
            <div class="mob-btn" style="grid-column: span 2; background:#335;" onpointerdown="showKeyboard()">KEYBOARD</div>
        </div>
    </div>

    <input type="text" id="keyboard-trap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">

    <script>
        /**
         * SUPER IBM 5150 SIMULATOR v2.0
         * Features: FileSystem, Apps, Games, Assembler, Matrix Effect, Themes
         */

        const SCREEN_COLS = 80;
        const SCREEN_ROWS = 25;
        
        const System = {
            power: false,
            mode: 'OFF', 
            currentApp: null,
            inputBuffer: '',
            path: 'A:\\',
            screenBuffer: [], 
            cursor: { x: 0, y: 0, visible: true },
            blinkInterval: null,
            theme: 'blue'
        };

        const FileSystem = {
            "README.TXT": "IBM DOS 3.1 Simulator Enhanced\n\nCOMMANDS:\n- HELP: List all commands\n- COLOR [GREEN/AMBER/BLUE]: Change Theme\n- MATRIX: Screen saver effect\n- CALC: Calculator\n- SNAKE: Snake Game\n- DRAW: Drawing Tool\n- DB: Database\n- ASM: Assembler\n- EDIT [FILE]: Text Editor",
            "AUTOEXEC.BAT": "ECHO OFF\nCLS\nDATE",
            "TODO.TXT": "1. Buy Pizza\n2. Fix Y2K Bug\n3. Learn Assembler",
        };

        const displayEl = document.getElementById('crt-display');
        const trap = document.getElementById('keyboard-trap');

        // --- Core Screen Functions ---

        function initScreen() {
            displayEl.innerHTML = '';
            System.screenBuffer = [];
            for (let r = 0; r < SCREEN_ROWS; r++) {
                let row = [];
                for (let c = 0; c < SCREEN_COLS; c++) {
                    const span = document.createElement('span');
                    span.className = 'char-cell';
                    span.textContent = '\u00A0'; 
                    displayEl.appendChild(span);
                    row.push({ char: ' ', attr: 0, element: span });
                }
                System.screenBuffer.push(row);
            }
        }

        function clearScreen() {
            for (let r = 0; r < SCREEN_ROWS; r++) {
                for (let c = 0; c < SCREEN_COLS; c++) {
                    putChar(c, r, ' ');
                }
            }
            System.cursor.x = 0;
            System.cursor.y = 0;
        }

        function putChar(x, y, char, invert = false) {
            if (x < 0 || x >= SCREEN_COLS || y < 0 || y >= SCREEN_ROWS) return;
            const cell = System.screenBuffer[y][x];
            cell.char = char;
            cell.element.textContent = char === ' ' ? '\u00A0' : char;
            if (invert) cell.element.classList.add('inverted');
            else cell.element.classList.remove('inverted');
        }

        function print(text, newLine = true) {
            if (text === undefined || text === null) return;
            text = text.toString();
            for (let i = 0; i < text.length; i++) {
                let char = text[i];
                if (char === '\n') {
                    newLineLogic();
                } else {
                    putChar(System.cursor.x, System.cursor.y, char);
                    System.cursor.x++;
                    if (System.cursor.x >= SCREEN_COLS) {
                        newLineLogic();
                    }
                }
            }
            if (newLine) newLineLogic();
        }

        function printAt(x, y, text, invert = false) {
            for (let i = 0; i < text.length; i++) {
                putChar(x + i, y, text[i], invert);
            }
        }

        function newLineLogic() {
            System.cursor.x = 0;
            System.cursor.y++;
            if (System.cursor.y >= SCREEN_ROWS) {
                scrollUp();
                System.cursor.y = SCREEN_ROWS - 1;
            }
        }

        function scrollUp() {
            for (let r = 0; r < SCREEN_ROWS - 1; r++) {
                // Optimize: Swap text content directly
                for (let c = 0; c < SCREEN_COLS; c++) {
                    const curr = System.screenBuffer[r][c];
                    const next = System.screenBuffer[r+1][c];
                    curr.char = next.char;
                    curr.element.textContent = next.element.textContent;
                    
                    if (next.element.classList.contains('inverted')) curr.element.classList.add('inverted');
                    else curr.element.classList.remove('inverted');
                }
            }
            // Clear last line
            for (let c = 0; c < SCREEN_COLS; c++) {
                putChar(c, SCREEN_ROWS - 1, ' ');
            }
        }

        function renderCursor() {
            if (!System.power) return;
            const cell = System.screenBuffer[System.cursor.y]?.[System.cursor.x];
            if (!cell) return;
            
            // Toggle inverted state only if system is idle (DOS mode or Input wait)
            // Apps usually handle their own cursor drawing, but we can have a global blink
            if (System.cursor.visible) {
                cell.element.classList.toggle('inverted');
            }
        }

        // --- Audio ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function beep(freq = 440, duration = 0.1, type = 'square') {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type;
            osc.frequency.value = freq;
            gain.gain.value = 0.03;
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + duration);
        }

        // --- System Power ---
        function toggleSystemPower() {
            const led = document.getElementById('power-led');
            if (System.power) {
                // Shutdown
                System.power = false;
                System.mode = 'OFF';
                led.classList.remove('on');
                clearInterval(System.blinkInterval);
                displayEl.innerHTML = ''; 
                trap.blur();
            } else {
                // Boot
                initScreen();
                System.power = true;
                System.mode = 'BOOT';
                led.classList.add('on');
                focusTrap();
                
                System.blinkInterval = setInterval(renderCursor, 500);
                bootSequence();
            }
        }

        async function bootSequence() {
            beep(120, 0.1, 'sawtooth'); 
            await delay(200);
            beep(120, 0.1, 'sawtooth');
            await delay(800);
            
            print("IBM Personal Computer BIOS v4.77");
            await delay(300);
            print("Copyright IBM Corp 1981, 1988");
            await delay(300);
            
            print("640 KB System RAM Passed");
            await delay(500);
            
            print("Loading DOS...");
            beep(600, 0.05);
            await delay(800);
            
            clearScreen();
            System.mode = 'DOS';
            print("IBM DOS Version 3.10 (Enhanced)");
            print("(C)Copyright IBM Corp 1981-1988");
            print("");
            print("Type 'HELP' for instructions.");
            prompt();
        }

        function delay(ms) { return new Promise(r => setTimeout(r, ms)); }
        function prompt() { print(System.path + ">", false); }

        // --- Input Handling ---
        function focusTrap() {
            if(System.power) trap.focus();
        }

        function showKeyboard() {
            trap.focus();
        }

        // Mobile Button Helper
        window.simulateKey = function(key) {
            const event = new KeyboardEvent('keydown', { key: key });
            document.dispatchEvent(event);
        };

        document.addEventListener('keydown', (e) => {
            if (!System.power) return;
            focusTrap();

            // Prevent browser shortcuts
            if(e.key === 'Tab' || e.key === 'Alt') e.preventDefault();
            
            if (System.currentApp) {
                System.currentApp.handleInput(e);
            } else if (System.mode === 'DOS') {
                handleDOSInput(e);
            }
        });

        function handleDOSInput(e) {
            // Remove cursor highlight before moving
            const cell = System.screenBuffer[System.cursor.y][System.cursor.x];
            cell.element.classList.remove('inverted');

            if (e.key === 'Enter') {
                processCommand();
            } else if (e.key === 'Backspace') {
                if (System.inputBuffer.length > 0) {
                    System.inputBuffer = System.inputBuffer.slice(0, -1);
                    System.cursor.x--;
                    putChar(System.cursor.x, System.cursor.y, ' ');
                }
            } else if (e.key.length === 1 && !e.ctrlKey && !e.altKey && !e.metaKey) {
                // Only print visible chars
                System.inputBuffer += e.key;
                print(e.key, false);
            }
        }

        function processCommand() {
            const cmdLine = System.inputBuffer.trim();
            System.inputBuffer = '';
            print(""); // New line

            if (!cmdLine) { prompt(); return; }

            const parts = cmdLine.split(' ');
            const cmd = parts[0].toUpperCase();
            const arg = parts[1] ? parts[1].toUpperCase() : null;

            switch (cmd) {
                case 'CLS': clearScreen(); break;
                case 'DIR': listFiles(); break;
                case 'DEL': deleteFile(arg); break;
                case 'HELP': showHelp(); break;
                case 'COLOR': changeTheme(arg); break;
                case 'MATRIX': launchApp(new MatrixApp()); break;
                case 'DRAW': launchApp(new DrawApp()); break;
                case 'SNAKE': launchApp(new SnakeApp()); break;
                case 'DB': launchApp(new DBApp()); break;
                case 'CALC': launchApp(new CalcApp()); break;
                case 'EDIT': launchApp(new EditApp(arg)); break;
                case 'ASM': launchApp(new AsmApp(arg)); break;
                case 'DATE': print(new Date().toDateString()); break;
                case 'TIME': print(new Date().toLocaleTimeString()); break;
                case 'VER': print("IBM Personal Computer DOS Version 3.10"); break;
                default:
                    if (FileSystem[cmd] || FileSystem[cmd + ".TXT"]) {
                        print("Use 'EDIT' to view text files.");
                    } else {
                        print("Bad command or file name");
                    }
            }

            if (!System.currentApp) prompt();
        }

        function listFiles() {
            print(" Volume in drive A is WORKBENCH");
            print(" Directory of A:\\");
            print("");
            let count = 0;
            for (let f in FileSystem) {
                let size = FileSystem[f].length * 10;
                let spaces = " ".repeat(Math.max(1, 14 - f.length));
                print(` ${f}${spaces}${size}`);
                count++;
            }
            print(`        ${count} File(s)`);
        }

        function showHelp() {
            print("Available Commands:");
            print("-------------------");
            print(" DIR     - List files");
            print(" CLS     - Clear screen");
            print(" COLOR   - Change theme (GREEN, AMBER, WHITE, BLUE)");
            print(" DRAW    - Draw with keyboard");
            print(" SNAKE   - Snake Game");
            print(" CALC    - Simple Calculator");
            print(" MATRIX  - Screen saver");
            print(" ASM     - 8088 Assembler");
            print(" DB      - Database");
            print(" EDIT    - Text Editor");
        }

        function deleteFile(filename) {
            if (!filename) { print("Error: Missing filename"); return; }
            if (FileSystem[filename]) {
                delete FileSystem[filename];
                print("File deleted.");
            } else {
                print("File not found.");
            }
        }

        function changeTheme(color) {
            const casing = document.getElementById('casing');
            casing.classList.remove('theme-green', 'theme-amber', 'theme-white');
            
            if (color === 'GREEN') casing.classList.add('theme-green');
            else if (color === 'AMBER') casing.classList.add('theme-amber');
            else if (color === 'WHITE') casing.classList.add('theme-white');
            // Default is blue
            
            print(`Theme changed to ${color || 'BLUE'}`);
        }

        function launchApp(app) {
            System.currentApp = app;
            System.mode = 'APP';
            clearScreen();
            app.init();
        }

        function closeApp() {
            System.currentApp = null;
            System.mode = 'DOS';
            clearScreen();
            prompt();
        }

        // ==========================================
        //  APP: MATRIX (Rain Effect)
        // ==========================================
        class MatrixApp {
            constructor() {
                this.drops = [];
                for(let i=0; i<SCREEN_COLS; i++) this.drops[i] = Math.random() * -50;
                this.timer = null;
                this.chars = "010101XYZAOB@#$%^&*";
            }
            init() {
                this.timer = setInterval(() => this.update(), 50);
            }
            update() {
                // Dim screen slightly manually or just overwrite
                // For simplicity, we just draw new chars
                for (let i = 0; i < this.drops.length; i++) {
                    const char = this.chars[Math.floor(Math.random() * this.chars.length)];
                    const y = Math.floor(this.drops[i]);
                    
                    if (y >= 0 && y < SCREEN_ROWS) {
                        // Draw head (white/bright)
                        putChar(i, y, char, true); 
                        // Dim tail
                        if (y > 0) putChar(i, y - 1, System.screenBuffer[y-1][i].char, false);
                    }
                    
                    this.drops[i]++;
                    
                    if (this.drops[i] > SCREEN_ROWS && Math.random() > 0.95) {
                        this.drops[i] = 0;
                        // Clean column logic would be nice but complex for this grid
                    }
                }
            }
            handleInput(e) {
                clearInterval(this.timer);
                closeApp();
            }
        }

        // ==========================================
        //  APP: CALCULATOR
        // ==========================================
        class CalcApp {
            constructor() {
                this.input = "";
                this.result = "";
            }
            init() {
                this.render();
            }
            render() {
                clearScreen();
                printAt(25, 5, "==============================");
                printAt(25, 6, "|      BASIC CALCULATOR      |");
                printAt(25, 7, "==============================");
                printAt(25, 9, ` INPUT: ${this.input}`);
                printAt(25, 11,` RESULT: ${this.result}`, true);
                
                printAt(20, 20, "Type numbers and +, -, *, /. ENTER to calc. ESC to quit.");
            }
            handleInput(e) {
                if (e.key === 'Escape') closeApp();
                else if (e.key === 'Enter') {
                    try {
                        // Safe evaluation
                        if (/^[0-9+\-*/.() ]+$/.test(this.input)) {
                            // eslint-disable-next-line no-eval
                            this.result = eval(this.input); 
                        } else {
                            this.result = "ERROR";
                        }
                    } catch {
                        this.result = "ERROR";
                    }
                    this.input = "";
                    this.render();
                } else if (e.key === 'Backspace') {
                    this.input = this.input.slice(0, -1);
                    this.render();
                } else if ("0123456789+-*/.()".includes(e.key)) {
                    this.input += e.key;
                    this.render();
                }
            }
        }

        // ==========================================
        //  APP: SNAKE
        // ==========================================
        class SnakeApp {
            constructor() {
                this.snake = [{x: 40, y: 12}];
                this.dir = {x: 1, y: 0};
                this.food = {x: 10, y: 10};
                this.score = 0;
                this.gameOver = false;
                this.timer = null;
            }
            init() {
                this.spawnFood();
                this.timer = setInterval(() => this.update(), 100);
            }
            spawnFood() {
                do {
                    this.food = {
                        x: Math.floor(Math.random() * SCREEN_COLS),
                        y: Math.floor(Math.random() * SCREEN_ROWS)
                    };
                } while (this.snake.some(s => s.x === this.food.x && s.y === this.food.y));
            }
            update() {
                if (this.gameOver) return;
                let head = {x: this.snake[0].x + this.dir.x, y: this.snake[0].y + this.dir.y};

                if (head.x < 0 || head.x >= SCREEN_COLS || head.y < 0 || head.y >= SCREEN_ROWS ||
                    this.snake.some(s => s.x === head.x && s.y === head.y)) {
                    this.endGame(); return;
                }

                this.snake.unshift(head);
                if (head.x === this.food.x && head.y === this.food.y) {
                    this.score += 10;
                    beep(800, 0.05);
                    this.spawnFood();
                } else {
                    this.snake.pop();
                }
                this.draw();
            }
            draw() {
                clearScreen();
                // Draw Border (Optional, skipped for clean look)
                // Draw Food
                putChar(this.food.x, this.food.y, '♥', true);
                // Draw Snake
                this.snake.forEach((s, i) => putChar(s.x, s.y, i===0?'O':'o'));
                printAt(0, 0, `SCORE: ${this.score}`);
            }
            endGame() {
                this.gameOver = true;
                clearInterval(this.timer);
                printAt(35, 12, "GAME OVER", true);
                printAt(32, 13, "Press ESC to Exit");
                beep(100, 0.5, 'sawtooth');
            }
            handleInput(e) {
                if (e.key === 'Escape') { clearInterval(this.timer); closeApp(); }
                if (e.key === 'ArrowUp' && this.dir.y === 0) this.dir = {x: 0, y: -1};
                if (e.key === 'ArrowDown' && this.dir.y === 0) this.dir = {x: 0, y: 1};
                if (e.key === 'ArrowLeft' && this.dir.x === 0) this.dir = {x: -1, y: 0};
                if (e.key === 'ArrowRight' && this.dir.x === 0) this.dir = {x: 1, y: 0};
            }
        }

        // ==========================================
        //  APP: DRAW
        // ==========================================
        class DrawApp {
            constructor() {
                this.x = 40; this.y = 12;
                this.penDown = false;
                this.char = '█';
                this.chars = ['█', '▓', '▒', '░', '*', '#', '@', '+', '.', 'X'];
                this.idx = 0;
            }
            init() {
                printAt(0, 0, "DRAW: ARROWS=Move SPC=Pen 'C'=Change 'S'=Save ESC=Exit", true);
            }
            handleInput(e) {
                if (e.key === 'Escape') closeApp();
                if (e.key === 'ArrowUp') this.y = Math.max(1, this.y - 1);
                if (e.key === 'ArrowDown') this.y = Math.min(SCREEN_ROWS - 1, this.y + 1);
                if (e.key === 'ArrowLeft') this.x = Math.max(0, this.x - 1);
                if (e.key === 'ArrowRight') this.x = Math.min(SCREEN_COLS - 1, this.x + 1);
                
                if (e.key === ' ') {
                    this.penDown = !this.penDown;
                    beep(this.penDown ? 600 : 300, 0.05);
                }
                if (e.key.toUpperCase() === 'C') {
                    this.idx = (this.idx + 1) % this.chars.length;
                    this.char = this.chars[this.idx];
                    printAt(60, 0, `Char:${this.char}`, true);
                }
                if (e.key.toUpperCase() === 'S') {
                    FileSystem["ART.TXT"] = "Draw Data";
                    printAt(50, 0, "SAVED!", true);
                }

                if (this.penDown) putChar(this.x, this.y, this.char);
                System.cursor.x = this.x; System.cursor.y = this.y;
            }
        }

        // ==========================================
        //  APP: DB
        // ==========================================
        class DBApp {
            constructor() {
                this.records = [];
                this.state = 'MENU';
                this.tempInput = '';
                this.tempRecord = {};
            }
            init() {
                this.records = [
                    {name: "JOHN DOE", age: "25", job: "DEV"},
                    {name: "JANE SMITH", age: "32", job: "CEO"}
                ];
                this.renderMenu();
            }
            renderMenu() {
                clearScreen();
                printAt(0, 0, "IBM DATA MASTER v1.0", true);
                printAt(0, 2, "[1] ADD RECORD   [ESC] EXIT");
                printAt(0, 4, "NAME            AGE   JOB");
                printAt(0, 5, "------------------------------");
                this.records.forEach((r, i) => {
                    printAt(0, 6+i, `${r.name.padEnd(16)}${r.age.padEnd(6)}${r.job}`);
                });
            }
            handleInput(e) {
                if (this.state === 'MENU') {
                    if (e.key === 'Escape') closeApp();
                    if (e.key === '1') {
                        this.state = 'INPUT_NAME';
                        this.tempInput = '';
                        this.drawInput("NAME");
                    }
                } else {
                    if (e.key === 'Enter') {
                        if (this.state === 'INPUT_NAME') {
                            this.tempRecord.name = this.tempInput;
                            this.state = 'INPUT_AGE'; this.tempInput = ''; this.drawInput("AGE");
                        } else if (this.state === 'INPUT_AGE') {
                            this.tempRecord.age = this.tempInput;
                            this.state = 'INPUT_JOB'; this.tempInput = ''; this.drawInput("JOB");
                        } else if (this.state === 'INPUT_JOB') {
                            this.tempRecord.job = this.tempInput;
                            this.records.push(this.tempRecord);
                            this.tempRecord = {};
                            this.state = 'MENU';
                            this.renderMenu();
                        }
                    } else if (e.key === 'Backspace') {
                        this.tempInput = this.tempInput.slice(0, -1);
                        this.updateInputDisplay();
                    } else if (e.key.length === 1) {
                        this.tempInput += e.key.toUpperCase();
                        this.updateInputDisplay();
                    }
                }
            }
            drawInput(label) {
                printAt(0, 20, "                              ");
                printAt(0, 20, `${label}: `);
            }
            updateInputDisplay() {
                printAt(10, 20, this.tempInput + "_ ");
            }
        }

        // ==========================================
        //  APP: EDIT
        // ==========================================
        class EditApp {
            constructor(filename) {
                this.filename = filename || "UNTITLED.TXT";
                this.lines = [""];
                this.cy = 0; this.cx = 0;
            }
            init() {
                if(FileSystem[this.filename]) this.lines = FileSystem[this.filename].split('\n');
                this.render();
            }
            render() {
                clearScreen();
                printAt(0, 0, `EDIT: ${this.filename} - F2:SAVE ESC:EXIT`, true);
                for(let i=0; i<Math.min(23, this.lines.length); i++) {
                    printAt(0, i+1, this.lines[i]);
                }
                System.cursor.x = this.cx;
                System.cursor.y = this.cy + 1;
            }
            handleInput(e) {
                if(e.key === 'Escape') closeApp();
                else if(e.key === 'F2') {
                    FileSystem[this.filename] = this.lines.join('\n');
                    printAt(60,0, "SAVED", true);
                }
                else if(e.key === 'ArrowUp') { this.cy = Math.max(0, this.cy-1); this.cx = Math.min(this.cx, this.lines[this.cy].length); }
                else if(e.key === 'ArrowDown') { if(this.cy < this.lines.length-1) this.cy++; this.cx = Math.min(this.cx, this.lines[this.cy].length); }
                else if(e.key === 'ArrowLeft') this.cx = Math.max(0, this.cx-1);
                else if(e.key === 'ArrowRight') this.cx = Math.min(this.lines[this.cy].length, this.cx+1);
                else if(e.key === 'Enter') {
                    const l = this.lines[this.cy];
                    this.lines[this.cy] = l.substring(0, this.cx);
                    this.lines.splice(this.cy+1, 0, l.substring(this.cx));
                    this.cy++; this.cx = 0;
                }
                else if(e.key === 'Backspace') {
                    if(this.cx > 0) {
                        const l = this.lines[this.cy];
                        this.lines[this.cy] = l.slice(0, this.cx-1) + l.slice(this.cx);
                        this.cx--;
                    } else if(this.cy > 0) {
                        this.cx = this.lines[this.cy-1].length;
                        this.lines[this.cy-1] += this.lines[this.cy];
                        this.lines.splice(this.cy, 1);
                        this.cy--;
                    }
                }
                else if(e.key.length === 1) {
                    const l = this.lines[this.cy];
                    this.lines[this.cy] = l.slice(0, this.cx) + e.key + l.slice(this.cx);
                    this.cx++;
                }
                this.render();
            }
        }

        // ==========================================
        //  APP: ASSEMBLER
        // ==========================================
        class AsmApp {
            constructor(filename) {
                this.regs = { AX:0, BX:0, CX:0, DX:0 };
            }
            init() {
                print("IBM 8088 Macro Assembler");
                print("Enter instruction (e.g., MOV AX 5). Type EXIT to quit.");
            }
            handleInput(e) {
                // Use standard DOS input logic for the command line style interface
                const cell = System.screenBuffer[System.cursor.y][System.cursor.x];
                cell.element.classList.remove('inverted');

                if (e.key === 'Enter') {
                    const line = System.inputBuffer.trim();
                    System.inputBuffer = '';
                    print(""); 
                    if(line) this.exec(line);
                    else print(">");
                } else if (e.key === 'Backspace') {
                    if (System.inputBuffer.length > 0) {
                        System.inputBuffer = System.inputBuffer.slice(0, -1);
                        System.cursor.x--;
                        putChar(System.cursor.x, System.cursor.y, ' ');
                    }
                } else if (e.key.length === 1) {
                    System.inputBuffer += e.key;
                    print(e.key, false);
                }
            }
            exec(line) {
                const parts = line.replace(',',' ').trim().toUpperCase().split(/\s+/);
                const op = parts[0];
                if (op === 'EXIT') { closeApp(); return; }
                
                try {
                    const getVal = v => this.regs[v] !== undefined ? this.regs[v] : parseInt(v);
                    
                    if(op === 'MOV') this.regs[parts[1]] = getVal(parts[2]);
                    else if(op === 'ADD') this.regs[parts[1]] += getVal(parts[2]);
                    else if(op === 'SUB') this.regs[parts[1]] -= getVal(parts[2]);
                    else if(op === 'INT' && parts[1] === '21') print(`> OUTPUT: ${this.regs.AX}`);
                    else if(op === 'PRINT') print(parts.slice(1).join(' '));
                    else throw new Error("Unknown Opcode");
                    
                    print(`AX=${this.regs.AX} BX=${this.regs.BX} CX=${this.regs.CX} DX=${this.regs.DX}`);
                } catch(err) {
                    print("ASM ERROR: " + err.message);
                }
            }
        }

    </script>
</body>
</html>
