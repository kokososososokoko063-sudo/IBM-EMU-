<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super IBM 5150 System</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');

        :root {
            --bezel-color: #dcd6c8;
            --screen-black: #080808;
            --phosphor-main: #55ffff; /* أزرق سماوي ساطع */
            --phosphor-dim: #00aaaa;
            --phosphor-glow: rgba(85, 255, 255, 0.4);
        }

        * { box-sizing: border-box; }

        body {
            background-color: #111;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
            font-family: 'VT323', monospace;
            user-select: none;
        }

        .monitor-casing {
            width: 95vw;
            max-width: 960px;
            aspect-ratio: 4/3;
            background-color: var(--bezel-color);
            border-radius: 30px;
            padding: 40px;
            position: relative;
            box-shadow: 
                inset 0 0 40px rgba(0,0,0,0.3),
                0 0 100px rgba(0,0,0,0.8),
                20px 20px 0px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .badge-ibm {
            position: absolute;
            top: 20px;
            left: 40px;
            background: #333;
            color: #ddd;
            padding: 2px 10px;
            font-family: 'Courier New', serif;
            font-weight: bold;
            border: 1px solid #666;
            box-shadow: 1px 1px 3px black;
            font-size: 18px;
            letter-spacing: 1px;
            z-index: 10;
        }

        .screen-container {
            width: 100%;
            height: 85%;
            background: #000;
            border-radius: 60% / 10%;
            border-top-left-radius: 30px; 
            border-top-right-radius: 30px;
            border-bottom-left-radius: 30px;
            border-bottom-right-radius: 30px;
            position: relative;
            overflow: hidden;
            box-shadow: inset 0 0 60px rgba(255,255,255,0.1);
            border: 20px solid #222;
        }

        /* الطبقة التي تحتوي على النص */
        #crt-display {
            width: 100%;
            height: 100%;
            background-color: var(--screen-black);
            color: var(--phosphor-main);
            font-size: 1.4rem; /* حجم الخط */
            line-height: 1;
            white-space: pre;
            padding: 20px;
            text-shadow: 0 0 4px var(--phosphor-dim), 0 0 2px var(--phosphor-glow);
            font-family: 'VT323', monospace;
            overflow: hidden;
            cursor: none;
            display: grid;
            grid-template-rows: repeat(25, 1fr);
            grid-template-columns: repeat(80, 1fr);
            gap: 0;
            direction: ltr;
        }

        /* الخلية الفردية في الشبكة */
        .char-cell {
            display: inline-block;
            width: 100%;
            height: 100%;
            text-align: center;
        }
        
        .char-cell.inverted {
            background-color: var(--phosphor-main);
            color: var(--screen-black);
            text-shadow: none;
        }

        /* تأثيرات الشاشة القديمة */
        .overlay-scanlines {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%);
            background-size: 100% 4px;
            pointer-events: none;
            z-index: 10;
        }
        
        .overlay-glow {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: radial-gradient(circle, rgba(85,255,255,0.05) 0%, rgba(0,0,0,0.6) 90%);
            pointer-events: none;
            z-index: 9;
            animation: pulse 4s infinite;
        }

        @keyframes pulse { 0% { opacity: 0.8; } 50% { opacity: 1; } 100% { opacity: 0.8; } }

        /* عناصر التحكم */
        .controls-panel {
            margin-top: auto;
            width: 100%;
            display: flex;
            justify-content: flex-end;
            padding-right: 50px;
            gap: 20px;
            align-items: center;
        }

        .switch-housing {
            background: #111;
            padding: 5px;
            border-radius: 4px;
            border: 1px solid #555;
        }

        .big-red-switch {
            width: 60px;
            height: 35px;
            background: #a00;
            border: 4px solid #600;
            cursor: pointer;
            box-shadow: inset 2px 2px 5px rgba(255,255,255,0.2);
        }

        .big-red-switch:active { background: #800; transform: scale(0.98); }

        .led-indicator {
            width: 15px; height: 15px;
            background: #200;
            border-radius: 50%;
            border: 1px solid #000;
            transition: 0.2s;
        }
        .led-indicator.on {
            background: #0f0;
            box-shadow: 0 0 10px #0f0;
        }

        /* إدخال مخفي */
        #keyboard-trap { position: absolute; opacity: 0; top: -1000px; }

    </style>
</head>
<body>

    <div class="monitor-casing">
        <div class="badge-ibm">IBM Personal Computer</div>
        
        <div class="screen-container">
            <div class="overlay-scanlines"></div>
            <div class="overlay-glow"></div>
            <!-- الشاشة عبارة عن شبكة من الخلايا -->
            <div id="crt-display"></div>
        </div>

        <div class="controls-panel">
            <div class="led-indicator" id="power-led"></div>
            <div style="width: 40px; height: 40px; background: #bbb; border-radius: 50%; border: 1px solid #888; box-shadow: 2px 2px 5px #000;"></div>
            <div class="switch-housing">
                <div class="big-red-switch" onclick="toggleSystemPower()"></div>
            </div>
        </div>
    </div>

    <input type="text" id="keyboard-trap" autocomplete="off">

    <script>
        /**
         * محاكي IBM 5150
         * يتضمن: نظام ملفات، إدارة ذاكرة الشاشة، معالج أوامر، وتطبيقات مدمجة
         */

        // --- الثوابت والإعدادات ---
        const SCREEN_COLS = 80;
        const SCREEN_ROWS = 25;
        const RAM_SIZE = 640; // KB
        
        // --- حالة النظام ---
        const System = {
            power: false,
            booting: false,
            mode: 'OFF', // OFF, BOOT, DOS, APP
            currentApp: null,
            inputBuffer: '',
            path: 'A:\\',
            screenBuffer: [], // مصفوفة ثنائية الأبعاد للحروف
            cursor: { x: 0, y: 0, visible: true },
            blinkInterval: null
        };

        // --- نظام الملفات ---
        const FileSystem = {
            "README.TXT": "IBM DOS 3.1 Simulator\n\nCOMMANDS:\n- DIR: List files\n- CLS: Clear screen\n- DRAW: Keyboard Drawing Tool\n- SNAKE: Snake Game\n- DB: Simple Database\n- EDIT [FILE]: Text Editor\n- ASM: 8088 Assembler & Compiler\n- DEL [FILE]: Delete file",
            
            "HELLO.ASM": "; Simple Counter Program\nMOV CX, 5\nSTART:\n  MOV AX, CX\n  INT 21 ; Print Number in AX\n  LOOP START\nINT 20 ; Exit",
            
            "NOTES.TXT": "Project Alpha details:\nMeeting at 5PM.\nBuy more floppy disks.",

            "DB.DAT": "NAME,AGE,JOB\nJOHN,25,DEV\nSARAH,30,ENG\nALI,22,STUDENT"
        };

        // --- تهيئة الشاشة ---
        const displayEl = document.getElementById('crt-display');
        
        function initScreen() {
            displayEl.innerHTML = '';
            System.screenBuffer = [];
            for (let r = 0; r < SCREEN_ROWS; r++) {
                let row = [];
                for (let c = 0; c < SCREEN_COLS; c++) {
                    const span = document.createElement('span');
                    span.className = 'char-cell';
                    span.textContent = '\u00A0'; // مسافة غير مرئية للحفاظ على الحجم
                    displayEl.appendChild(span);
                    row.push({ char: ' ', attr: 0, element: span });
                }
                System.screenBuffer.push(row);
            }
        }

        // --- دوال الرسم على الشاشة ---
        function clearScreen() {
            for (let r = 0; r < SCREEN_ROWS; r++) {
                for (let c = 0; c < SCREEN_COLS; c++) {
                    putChar(c, r, ' ');
                }
            }
            System.cursor.x = 0;
            System.cursor.y = 0;
        }

        function putChar(x, y, char, invert = false) {
            if (x < 0 || x >= SCREEN_COLS || y < 0 || y >= SCREEN_ROWS) return;
            const cell = System.screenBuffer[y][x];
            cell.char = char;
            cell.element.textContent = char === ' ' ? '\u00A0' : char;
            if (invert) cell.element.classList.add('inverted');
            else cell.element.classList.remove('inverted');
        }

        function print(text, newLine = true) {
            for (let i = 0; i < text.length; i++) {
                let char = text[i];
                if (char === '\n') {
                    newLineLogic();
                } else {
                    putChar(System.cursor.x, System.cursor.y, char);
                    System.cursor.x++;
                    if (System.cursor.x >= SCREEN_COLS) {
                        newLineLogic();
                    }
                }
            }
            if (newLine) newLineLogic();
        }

        function printAt(x, y, text, invert = false) {
            for (let i = 0; i < text.length; i++) {
                putChar(x + i, y, text[i], invert);
            }
        }

        function newLineLogic() {
            System.cursor.x = 0;
            System.cursor.y++;
            if (System.cursor.y >= SCREEN_ROWS) {
                scrollUp();
                System.cursor.y = SCREEN_ROWS - 1;
            }
        }

        function scrollUp() {
            for (let r = 0; r < SCREEN_ROWS - 1; r++) {
                for (let c = 0; c < SCREEN_COLS; c++) {
                    const nextRowChar = System.screenBuffer[r+1][c].char;
                    const nextRowInv = System.screenBuffer[r+1][c].element.classList.contains('inverted');
                    putChar(c, r, nextRowChar, nextRowInv);
                }
            }
            // مسح السطر الأخير
            for (let c = 0; c < SCREEN_COLS; c++) {
                putChar(c, SCREEN_ROWS - 1, ' ');
            }
        }

        function renderCursor() {
            // وميض المؤشر
            const cell = System.screenBuffer[System.cursor.y]?.[System.cursor.x];
            if (!cell) return;
            
            if (System.cursor.visible) {
                cell.element.classList.toggle('inverted');
            } else {
                // تأكد من إزالة العكس إذا كان يجب أن يكون مخفيًا
                // لكن يجب أن نحترم حالة الرسم الأصلية (للبرامج)
                // للتبسيط، في DOS shell المؤشر يعكس اللون
            }
        }

        // --- الصوت ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        function beep(freq = 440, duration = 0.1) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = 'square';
            osc.frequency.value = freq;
            gain.gain.value = 0.05;
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + duration);
        }

        // --- تشغيل النظام ---
        function toggleSystemPower() {
            const led = document.getElementById('power-led');
            if (System.power) {
                // Shutdown
                System.power = false;
                System.mode = 'OFF';
                led.classList.remove('on');
                clearInterval(System.blinkInterval);
                displayEl.innerHTML = ''; 
                document.getElementById('keyboard-trap').blur();
            } else {
                // Boot
                initScreen(); // إعادة بناء الشبكة
                System.power = true;
                System.mode = 'BOOT';
                led.classList.add('on');
                document.getElementById('keyboard-trap').focus();
                
                // وميض المؤشر
                System.blinkInterval = setInterval(renderCursor, 500);
                
                bootSequence();
            }
        }

        async function bootSequence() {
            beep(100, 0.2); // HDD noise simulation start
            await delay(1000);
            print("IBM Personal Computer BIOS v3.0");
            await delay(500);
            print("Copyright IBM Corp 1981, 1985");
            await delay(500);
            print("Checking Memory", false);
            for(let i=0; i<64; i++) {
                if(i%5===0) { print(".", false); beep(800 + i*10, 0.01); }
                await delay(20);
            }
            print(" OK");
            await delay(800);
            print("Loading DOS...");
            beep(440, 0.3); // Boot beep
            await delay(1000);
            clearScreen();
            
            System.mode = 'DOS';
            print("IBM DOS Version 3.10");
            print("(C)Copyright IBM Corp 1981-1985");
            print("");
            prompt();
        }

        function delay(ms) { return new Promise(r => setTimeout(r, ms)); }
        function prompt() { print(System.path + ">", false); }

        // --- معالجة المدخلات ---
        document.addEventListener('keydown', (e) => {
            if (!System.power) return;
            document.getElementById('keyboard-trap').focus();
            
            // توجيه المدخلات حسب الوضع الحالي
            if (System.currentApp) {
                System.currentApp.handleInput(e);
            } else if (System.mode === 'DOS') {
                handleDOSInput(e);
            }
        });

        function handleDOSInput(e) {
            // إيقاف وميض المؤشر مؤقتاً لتحديث الشاشة
            const cell = System.screenBuffer[System.cursor.y][System.cursor.x];
            cell.element.classList.remove('inverted');

            if (e.key === 'Enter') {
                processCommand();
            } else if (e.key === 'Backspace') {
                if (System.inputBuffer.length > 0) {
                    System.inputBuffer = System.inputBuffer.slice(0, -1);
                    System.cursor.x--;
                    putChar(System.cursor.x, System.cursor.y, ' ');
                }
            } else if (e.key.length === 1) {
                System.inputBuffer += e.key;
                print(e.key, false);
            }
        }

        function processCommand() {
            const cmdLine = System.inputBuffer.trim();
            System.inputBuffer = '';
            print(""); // سطر جديد بعد الأمر

            if (!cmdLine) { prompt(); return; }

            const parts = cmdLine.split(' ');
            const cmd = parts[0].toUpperCase();
            const arg = parts[1] ? parts[1].toUpperCase() : null;

            switch (cmd) {
                case 'CLS': clearScreen(); break;
                case 'DIR': listFiles(); break;
                case 'DEL': deleteFile(arg); break;
                case 'DRAW': launchApp(new DrawApp()); break;
                case 'SNAKE': launchApp(new SnakeApp()); break;
                case 'DB': launchApp(new DBApp()); break;
                case 'EDIT': launchApp(new EditApp(arg)); break;
                case 'ASM': launchApp(new AsmApp(arg)); break;
                default:
                    // محاولة تشغيل ملف EXE إذا وجد
                    if (FileSystem[cmd] || FileSystem[cmd + ".EXE"]) {
                         // محاكاة تشغيل ملف، هنا سنفترض أن المستخدم يريد تشغيل ملفات ASM المحولة
                         if (cmd.endsWith('.EXE') && FileSystem[cmd].startsWith('$$EXE$$')) {
                             runCompiledExe(FileSystem[cmd]);
                         } else {
                             print("Program too big to fit in memory (Simulated)");
                         }
                    } else if (cmd.endsWith('.TXT')) {
                        print("Use 'TYPE' or 'EDIT' to view text files.");
                    } else {
                        print("Bad command or file name");
                    }
            }

            if (!System.currentApp) prompt();
        }

        function listFiles() {
            print(" Volume in drive A is WORKBENCH");
            print(" Directory of A:\\");
            print("");
            let count = 0;
            for (let f in FileSystem) {
                let size = FileSystem[f].length * 10; // حجم وهمي
                let spaces = " ".repeat(14 - f.length);
                print(` ${f}${spaces}${size}`);
                count++;
            }
            print(`        ${count} File(s)`);
        }

        function deleteFile(filename) {
            if (!filename) { print("Error: Missing filename"); return; }
            if (FileSystem[filename]) {
                delete FileSystem[filename];
                print("File deleted.");
            } else {
                print("File not found.");
            }
        }

        function launchApp(app) {
            System.currentApp = app;
            System.mode = 'APP';
            clearScreen();
            app.init();
        }

        function closeApp() {
            System.currentApp = null;
            System.mode = 'DOS';
            clearScreen();
            prompt();
        }

        // ==========================================
        //  APP: DRAW (الرسم بلوحة المفاتيح)
        // ==========================================
        class DrawApp {
            constructor() {
                this.x = 40;
                this.y = 12;
                this.penDown = false;
                this.char = '█';
                this.colorIndex = 0;
                this.chars = ['█', '▓', '▒', '░', '*', '#', '@'];
            }
            init() {
                printAt(0, 0, "DRAW TOOL v1.0 - ARROWS:Move SPACE:Pen C:Char S:Save ESC:Exit", true);
                this.updateCursor();
            }
            updateCursor() {
                // رسم نقطة وهمية ليعرف المستخدم مكانه
                // بما أن النظام يرسم المؤشر تلقائياً، نحتاج فقط لتحديث بيانات الرسم
            }
            handleInput(e) {
                const k = e.key;
                if (k === 'Escape') { closeApp(); return; }
                if (k === 'ArrowUp') this.y = Math.max(1, this.y - 1);
                if (k === 'ArrowDown') this.y = Math.min(SCREEN_ROWS - 1, this.y + 1);
                if (k === 'ArrowLeft') this.x = Math.max(0, this.x - 1);
                if (k === 'ArrowRight') this.x = Math.min(SCREEN_COLS - 1, this.x + 1);
                
                if (k === ' ') {
                    this.penDown = !this.penDown;
                    beep(this.penDown ? 800 : 400, 0.05);
                }
                
                if (k.toUpperCase() === 'C') {
                    this.colorIndex = (this.colorIndex + 1) % this.chars.length;
                    this.char = this.chars[this.colorIndex];
                    printAt(60, 0, `Char:${this.char}`, true);
                }

                if (k.toUpperCase() === 'S') {
                    // حفظ بسيط (محاكاة)
                    FileSystem["DRAWING.ART"] = "Saved Art Data...";
                    printAt(0, 24, "Saved to DRAWING.ART", true);
                    beep(1000, 0.2);
                }

                // الرسم
                if (this.penDown) {
                    putChar(this.x, this.y, this.char);
                }

                // تحديث مكان مؤشر النظام
                System.cursor.x = this.x;
                System.cursor.y = this.y;
            }
        }

        // ==========================================
        //  APP: SNAKE (لعبة)
        // ==========================================
        class SnakeApp {
            constructor() {
                this.snake = [{x: 40, y: 12}, {x: 39, y: 12}, {x: 38, y: 12}];
                this.dir = {x: 1, y: 0};
                this.food = {x: 10, y: 10};
                this.score = 0;
                this.gameOver = false;
                this.timer = null;
            }
            init() {
                this.spawnFood();
                this.timer = setInterval(() => this.update(), 150);
            }
            spawnFood() {
                this.food = {
                    x: Math.floor(Math.random() * SCREEN_COLS),
                    y: Math.floor(Math.random() * SCREEN_ROWS)
                };
            }
            update() {
                if (this.gameOver) return;

                // Move head
                let head = {x: this.snake[0].x + this.dir.x, y: this.snake[0].y + this.dir.y};

                // Collision Wall
                if (head.x < 0 || head.x >= SCREEN_COLS || head.y < 0 || head.y >= SCREEN_ROWS) {
                    this.endGame(); return;
                }
                // Collision Self
                if (this.snake.some(s => s.x === head.x && s.y === head.y)) {
                    this.endGame(); return;
                }

                this.snake.unshift(head);

                // Eat Food
                if (head.x === this.food.x && head.y === this.food.y) {
                    this.score += 10;
                    beep(1200, 0.05);
                    this.spawnFood();
                } else {
                    this.snake.pop();
                }

                this.draw();
            }
            draw() {
                clearScreen();
                // Draw Food
                putChar(this.food.x, this.food.y, '♥');
                // Draw Snake
                this.snake.forEach((s, i) => putChar(s.x, s.y, i===0?'O':'o'));
                // UI
                printAt(0, 0, `SCORE: ${this.score}`, true);
            }
            endGame() {
                this.gameOver = true;
                clearInterval(this.timer);
                printAt(35, 12, "GAME OVER", true);
                printAt(30, 13, "Press ESC to Exit");
                beep(150, 0.5);
            }
            handleInput(e) {
                if (e.key === 'Escape') { clearInterval(this.timer); closeApp(); }
                if (e.key === 'ArrowUp' && this.dir.y === 0) this.dir = {x: 0, y: -1};
                if (e.key === 'ArrowDown' && this.dir.y === 0) this.dir = {x: 0, y: 1};
                if (e.key === 'ArrowLeft' && this.dir.x === 0) this.dir = {x: -1, y: 0};
                if (e.key === 'ArrowRight' && this.dir.x === 0) this.dir = {x: 1, y: 0};
            }
        }

        // ==========================================
        //  APP: DATABASE (إدارة البيانات)
        // ==========================================
        class DBApp {
            constructor() {
                this.records = [];
                this.state = 'MENU'; // MENU, ADD, FIND
                this.tempInput = '';
            }
            init() {
                this.loadData();
                this.renderMenu();
            }
            loadData() {
                if(FileSystem['DB.DAT']) {
                    const lines = FileSystem['DB.DAT'].split('\n');
                    // Skip header
                    for(let i=1; i<lines.length; i++) {
                        const cols = lines[i].split(',');
                        if(cols.length === 3) this.records.push({name: cols[0], age: cols[1], job: cols[2]});
                    }
                }
            }
            renderMenu() {
                clearScreen();
                printAt(0, 0, "IBM DATA MASTER v1.0", true);
                printAt(0, 2, `Records: ${this.records.length}`);
                printAt(0, 4, "[1] LIST ALL");
                printAt(0, 5, "[2] ADD RECORD");
                printAt(0, 6, "[3] DELETE LAST");
                printAt(0, 7, "[ESC] EXIT");
                
                // Draw Table Header
                printAt(0, 10, "NAME            AGE   JOB          ", true);
                this.records.forEach((r, i) => {
                    if (i < 14) {
                        let line = `${r.name.padEnd(16)} ${r.age.padEnd(5)} ${r.job}`;
                        printAt(0, 11 + i, line);
                    }
                });
            }
            handleInput(e) {
                if (this.state === 'MENU') {
                    if (e.key === 'Escape') closeApp();
                    if (e.key === '2') {
                         this.state = 'ADD_NAME';
                         this.tempRecord = {};
                         this.tempInput = '';
                         this.drawInputBox("Enter Name:");
                    }
                    if (e.key === '3') {
                        this.records.pop();
                        this.renderMenu();
                    }
                } else if (this.state.startsWith('ADD')) {
                    if (e.key === 'Enter') {
                        if (this.state === 'ADD_NAME') {
                            this.tempRecord.name = this.tempInput;
                            this.state = 'ADD_AGE';
                            this.tempInput = '';
                            this.drawInputBox("Enter Age:");
                        } else if (this.state === 'ADD_AGE') {
                            this.tempRecord.age = this.tempInput;
                            this.state = 'ADD_JOB';
                            this.tempInput = '';
                            this.drawInputBox("Enter Job:");
                        } else if (this.state === 'ADD_JOB') {
                            this.tempRecord.job = this.tempInput;
                            this.records.push(this.tempRecord);
                            this.state = 'MENU';
                            this.renderMenu();
                        }
                    } else if (e.key.length === 1) {
                        this.tempInput += e.key.toUpperCase();
                        printAt(15, 21, this.tempInput);
                    }
                }
            }
            drawInputBox(label) {
                printAt(0, 20, "--------------------");
                printAt(0, 21, `${label} `);
            }
        }

        // ==========================================
        //  APP: EDITOR (محرر النصوص المطور)
        // ==========================================
        class EditApp {
            constructor(filename) {
                this.filename = filename || "UNTITLED.TXT";
                this.content = [];
                this.cx = 0;
                this.cy = 0;
            }
            init() {
                if (FileSystem[this.filename]) {
                    this.content = FileSystem[this.filename].split('\n');
                } else {
                    this.content = [""];
                }
                this.render();
            }
            render() {
                clearScreen();
                printAt(0, 0, `EDIT: ${this.filename}            F2: SAVE  ESC: EXIT`, true);
                for(let i=0; i<Math.min(23, this.content.length); i++) {
                    printAt(0, i+1, this.content[i]);
                }
                System.cursor.x = this.cx;
                System.cursor.y = this.cy + 1;
            }
            handleInput(e) {
                if (e.key === 'Escape') closeApp();
                else if (e.key === 'F2') {
                    FileSystem[this.filename] = this.content.join('\n');
                    printAt(60, 0, "SAVED!", true);
                    beep(800, 0.1);
                    setTimeout(() => this.render(), 1000);
                }
                else if (e.key === 'ArrowUp') {
                    if (this.cy > 0) this.cy--;
                    this.cx = Math.min(this.cx, this.content[this.cy].length);
                }
                else if (e.key === 'ArrowDown') {
                    if (this.cy < this.content.length - 1) this.cy++;
                    this.cx = Math.min(this.cx, this.content[this.cy].length);
                }
                else if (e.key === 'ArrowLeft') {
                    if (this.cx > 0) this.cx--;
                }
                else if (e.key === 'ArrowRight') {
                    if (this.cx < this.content[this.cy].length) this.cx++;
                }
                else if (e.key === 'Enter') {
                    const line = this.content[this.cy];
                    const rest = line.substring(this.cx);
                    this.content[this.cy] = line.substring(0, this.cx);
                    this.content.splice(this.cy + 1, 0, rest);
                    this.cy++;
                    this.cx = 0;
                }
                else if (e.key === 'Backspace') {
                    if (this.cx > 0) {
                        const line = this.content[this.cy];
                        this.content[this.cy] = line.slice(0, this.cx - 1) + line.slice(this.cx);
                        this.cx--;
                    } else if (this.cy > 0) {
                        // Merge with prev line
                        this.cx = this.content[this.cy - 1].length;
                        this.content[this.cy - 1] += this.content[this.cy];
                        this.content.splice(this.cy, 1);
                        this.cy--;
                    }
                }
                else if (e.key.length === 1) {
                    const line = this.content[this.cy];
                    this.content[this.cy] = line.slice(0, this.cx) + e.key + line.slice(this.cx);
                    this.cx++;
                }
                
                this.render();
            }
        }

        // ==========================================
        //  APP: ASM (المجمع المطور)
        // ==========================================
        class AsmApp {
            constructor(filename) {
                this.filename = filename;
                this.state = filename ? 'RUN_FILE' : 'INTERACTIVE';
                this.regs = { AX: 0, BX: 0, CX: 0, DX: 0 };
            }
            init() {
                if (this.state === 'RUN_FILE') {
                    this.compileAndRun(this.filename);
                } else {
                    print("IBM 8088 Macro Assembler");
                    print("Type code line by line. 'RUN' to execute. 'EXIT' to quit.");
                    print("To compile to EXE: 'BUILD filename'");
                }
            }
            handleInput(e) {
                if (System.mode === 'DOS') return; // Exit logic handled externally
                handleDOSInput(e); // Reuse shell input for REPL
                
                if (e.key === 'Enter') {
                    const cmd = System.inputBuffer.trim(); // Was cleared by handleDOSInput logic needs fix?
                    // Actually handleDOSInput clears buffer, so we need to intercept.
                    // For simplicity, let's reuse shell logic but redirect to ASM parser.
                }
                // *Hack*: Override processCommand for this app context in handleDOSInput if I wasn't lazy.
                // Instead, I will assume the user types lines and hits enter, triggering processCommand.
                // But wait, processCommand is global. 
                // Let's implement a simple REPL inside handleInput here properly.
            }
        }
        
        // إعادة تعريف logic للإدخال لـ ASM لأنه معقد قليلاً
        // سأستخدم منطق بسيط: إذا كنا في ASM، كل سطر هو تعليمة
        
        AsmApp.prototype.handleInput = function(e) {
             const cell = System.screenBuffer[System.cursor.y][System.cursor.x];
             cell.element.classList.remove('inverted');

             if (e.key === 'Enter') {
                 const line = System.inputBuffer.trim();
                 System.inputBuffer = '';
                 print(""); 
                 this.processLine(line);
             } else if (e.key === 'Backspace') {
                 if (System.inputBuffer.length > 0) {
                     System.inputBuffer = System.inputBuffer.slice(0, -1);
                     System.cursor.x--;
                     putChar(System.cursor.x, System.cursor.y, ' ');
                 }
             } else if (e.key.length === 1) {
                 System.inputBuffer += e.key;
                 print(e.key, false);
             }
        }

        AsmApp.prototype.processLine = function(line) {
            const parts = line.split(' ');
            const op = parts[0].toUpperCase();
            
            if (op === 'EXIT') { closeApp(); return; }
            if (op === 'CLS') { clearScreen(); return; }
            if (op === 'BUILD') {
                const fname = parts[1];
                if(fname) {
                    FileSystem[fname + ".EXE"] = "$$EXE$$" + JSON.stringify(this.history || []);
                    print(`Build successful: ${fname}.EXE`);
                } else {
                    print("Error: Specify filename");
                }
                return;
            }

            // Simple Execution
            try {
                this.executeOp(line);
                print(`AX=${this.regs.AX} BX=${this.regs.BX} CX=${this.regs.CX} DX=${this.regs.DX}`);
            } catch(err) {
                print("ASM Error: " + err.message);
            }
        }

        AsmApp.prototype.executeOp = function(line) {
            // محاكي بسيط جداً للأوامر
            line = line.replace(',', ' ').trim().toUpperCase();
            const tokens = line.split(/\s+/);
            const op = tokens[0];
            const dest = tokens[1];
            const src = tokens[2];
            
            const getVal = (v) => this.regs[v] !== undefined ? this.regs[v] : parseInt(v);

            if (op === 'MOV') this.regs[dest] = getVal(src);
            else if (op === 'ADD') this.regs[dest] += getVal(src);
            else if (op === 'SUB') this.regs[dest] -= getVal(src);
            else if (op === 'INC') this.regs[dest]++;
            else if (op === 'DEC') this.regs[dest]--;
            else if (op === 'INT') {
                if (dest === '21') print(`[INTERRUPT OUTPUT]: ${this.regs.AX}`);
            }
            // المزيد من الأوامر يمكن إضافتها هنا
        }
        
        // تشغيل الملفات المحفوظة
        function runCompiledExe(content) {
            print("Executing binary...");
            // محاكاة التنفيذ
            setTimeout(() => {
                print("Program finished.");
                prompt();
            }, 1000);
        }

    </script>
</body>
</html>
